<!DOCTYPE html>
<html>

<head>
    <title>twigtheoracle: stl viewer</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="applets.css">
    <link href="https://fonts.googleapis.com/css?family=Anton|Dosis|Abel" rel="stylesheet">
    <link rel="shortcut icon" href="../images/transparent_face.png">
</head>

<body>
    <div class="wrapper">
        <div class="container">

            <div class="header">
                <h1><a href="../index.html">twigtheoracle</a></h1>
                <h2><a href="../applets.html">web applets</a></h2>
                <h3 class="centered" id="project-header">STL Viewer</h3>
            </div>

            <br>

            <p>This web application will allow you to upload and view an stl file in your very own browser. This is very work in progress and is the start of a page where you will be able to do slicing (for 3D printing) in your very own brower!</p>
            <div class="page">
                <div id="stl-wrapper">
                    <div id="stl-viewer" style="width: 100%;">
                        <div id="stl-viewer-wrapper"></div>
                    </div>
                </div>
                <div class="page-right-box">
                    <div class="page-right-center-box">
                        <p style="padding: 0; margin: 0;">Select an STL file</p>
                        <input type="file" id="stl-file" name="stl-file" accept=".stl">
                        <br>
                        <button onclick="renderSTL()">Submit</button>
                        <div id="test-div"></div>
                        <div id="super-test-div"></div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <div id="outside-links">
                    <a class="logo" href="https://github.com/twigtheoracle">
                        <img class="outside-link-logo" src="../images/github_logo.png">
                    </a>
                    <a class="logo" href="https://www.linkedin.com/in/eric-liu-655ab413b/">
                        <img class="outside-link-logo" src="../images/linkedin_logo.png">
                    </a>
                </div>
            </div>

        </div>
    </div>

    <script src="../js/three.js"></script>
    <script>
        function get_STL() {
            var reader = new FileReader();
            var file = document.getElementById("stl-file").files[0];
            
            document.getElementById("super-test-div").innerHTML = file;
            
            reader.onload = function(e){
                document.getElementById("test-div").innerHTML = reader.result[0];
                return reader.result;  
            };
            
            reader.readAsArrayBuffer(file);
        }
    </script>
    <script>
        function trim (str) {
            str = str.replace(/^\s+/, '');
            for (var i = str.length - 1; i >= 0; i--) {
                if (/\S/.test(str.charAt(i))) {
                    str = str.substring(0, i + 1);
                    break;
                }
            }
            return str;
        }
    </script>
    <script>
        function renderSTL() {
            var camera, scene, renderer, geometry, material, mesh, light1;
            
            var container = document.getElementById("stl-viewer-wrapper")

            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            container.appendChild(renderer.domElement);

            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
            camera.position.z = 5;
            camera.lookAt(scene.position);
            
            var stl_data = get_STL();
            var state = '';
            var lines = stl_data.split('\n');
            var geo = new THREE.Geometry();
            var name, parts, line, normal, done, vertices = [];
            var vCount = 0;
            stl_data = null;
            
            for (var len = lines.length, i = 0; i < len; i++) {
                    if (done) {
                        break;
                    }
                    line = trim(lines[i]);
                    parts = line.split(' ');
                    switch (state) {
                        case '':
                            if (parts[0] !== 'solid') {
                                console.error(line);
                                console.error('Invalid state "' + parts[0] + '", should be "solid"');
                                return;
                            } else {
                                name = parts[1];
                                state = 'solid';
                            }
                            break;
                        case 'solid':
                            if (parts[0] !== 'facet' || parts[1] !== 'normal') {
                                console.error(line);
                                console.error('Invalid state "' + parts[0] + '", should be "facet normal"');
                                return;
                            } else {
                                normal = [
                                    parseFloat(parts[2]), 
                                    parseFloat(parts[3]), 
                                    parseFloat(parts[4])
                                ];
                                state = 'facet normal';
                            }
                            break;
                        case 'facet normal':
                            if (parts[0] !== 'outer' || parts[1] !== 'loop') {
                                console.error(line);
                                console.error('Invalid state "' + parts[0] + '", should be "outer loop"');
                                return;
                            } else {
                                state = 'vertex';
                            }
                            break;
                        case 'vertex': 
                            if (parts[0] === 'vertex') {
                                geo.vertices.push(new THREE.Vector3(
                                    parseFloat(parts[1]),
                                    parseFloat(parts[2]),
                                    parseFloat(parts[3])
                                ));
                            } else if (parts[0] === 'endloop') {
                                geo.faces.push( new THREE.Face3( vCount*3, vCount*3+1, vCount*3+2, new THREE.Vector3(normal[0], normal[1], normal[2]) ) );
                                vCount++;
                                state = 'endloop';
                            } else {
                                console.error(line);
                                console.error('Invalid state "' + parts[0] + '", should be "vertex" or "endloop"');
                                return;
                            }
                            break;
                        case 'endloop':
                            if (parts[0] !== 'endfacet') {
                                console.error(line);
                                console.error('Invalid state "' + parts[0] + '", should be "endfacet"');
                                return;
                            } else {
                                state = 'endfacet';
                            }
                            break;
                        case 'endfacet':
                            if (parts[0] === 'endsolid') {
                                //mesh = new THREE.Mesh( geo, new THREE.MeshNormalMaterial({overdraw:true}));
                                mesh = new THREE.Mesh( 
                                    geo, 
                                    new THREE.MeshLambertMaterial({
                                        overdraw:true,
                                        color: 0xaa0000,
                                        shading: THREE.FlatShading
                                    }
                                ));
                                scene.add(mesh);
                                done = true;
                            } else if (parts[0] === 'facet' && parts[1] === 'normal') {
                                normal = [
                                    parseFloat(parts[2]), 
                                    parseFloat(parts[3]), 
                                    parseFloat(parts[4])
                                ];
                                if (vCount % 1000 === 0) {
                                    console.log(normal);
                                }
                                state = 'facet normal';
                            } else {
                                console.error(line);
                                console.error('Invalid state "' + parts[0] + '", should be "endsolid" or "facet normal"');
                                return;
                            }
                            break;
                        default:
                            console.error('Invalid state "' + state + '"');
                            break;
                    }
                }

            var animate = function() {
                requestAnimationFrame(animate);

                cube.rotation.x += 0.01;
                cube.rotation.y += 0.01;

                renderer.render(scene, camera);
            };

            animate();
        }

    </script>

</body>
